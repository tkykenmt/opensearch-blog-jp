# OpenSearch クエリ実行フロー図

## 図1: Nested Query の実行フロー

```
┌─────────────────────────────────────────────────────────────┐
│                    Nested Query 実行                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1. ObjectMapper の取得                                      │
│     context.getObjectMapper(path)                           │
│     → ネストされたフィールドのマッピング情報                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. BitSetProducer の作成                                    │
│     context.bitsetFilter(objectMapper.nestedTypeFilter())   │
│     → 親ドキュメントを識別するビットセット                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. NestedScope に入る                                       │
│     context.nestedScope().nextLevel(nestedObjectMapper)     │
│     ┌─────────────────────────────────────────────┐         │
│     │  内部クエリの生成                            │         │
│     │  innerQuery = query.toQuery(context)        │         │
│     │  → 子ドキュメントに対するクエリ              │         │
│     └─────────────────────────────────────────────┘         │
│     context.nestedScope().previousLevel()                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. ToParentBlockJoinQuery の生成                            │
│     new OpenSearchToParentBlockJoinQuery(                   │
│         innerQuery,      // 子クエリ                         │
│         parentFilter,    // 親フィルター                     │
│         scoreMode        // スコア集約モード                 │
│     )                                                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. Lucene Block Join 実行                                   │
│     ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│     │ Parent Doc 1 │  │ Parent Doc 2 │  │ Parent Doc 3 │  │
│     ├──────────────┤  ├──────────────┤  ├──────────────┤  │
│     │ Child 1-1 ✓  │  │ Child 2-1 ✗  │  │ Child 3-1 ✓  │  │
│     │ Child 1-2 ✗  │  │ Child 2-2 ✗  │  │ Child 3-2 ✓  │  │
│     └──────────────┘  └──────────────┘  └──────────────┘  │
│          ✓                  ✗                  ✓           │
│     (マッチ)            (マッチなし)         (マッチ)        │
└─────────────────────────────────────────────────────────────┘
```

## 図2: Has_Child Query の実行フロー

```
┌─────────────────────────────────────────────────────────────┐
│                  Has_Child Query 実行                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1. ParentJoinFieldMapper の取得                             │
│     ParentJoinFieldMapper.getMapper(mapperService)          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. ParentIdFieldMapper の取得                               │
│     joinFieldMapper.getParentIdFieldMapper(type, false)     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. フィルターとクエリの作成                                  │
│     parentFilter = parentIdFieldMapper.getParentFilter()    │
│     childFilter = parentIdFieldMapper.getChildFilter(type)  │
│     innerQuery = Queries.filtered(query, childFilter)       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. LateParsingQuery の生成                                  │
│     new LateParsingQuery(                                   │
│         parentFilter,    // 親を識別                         │
│         innerQuery,      // 子クエリ                         │
│         minChildren,     // 最小子数                         │
│         maxChildren,     // 最大子数                         │
│         scoreMode        // スコア集約                       │
│     )                                                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. Query Rewrite 時の処理                                   │
│     ┌─────────────────────────────────────────────┐         │
│     │  OrdinalMap のロード                         │         │
│     │  fieldData.loadGlobal(reader)               │         │
│     │  → グローバル序数マップを取得                │         │
│     └─────────────────────────────────────────────┘         │
│                         │                                    │
│                         ▼                                    │
│     ┌─────────────────────────────────────────────┐         │
│     │  JoinUtil.createJoinQuery()                 │         │
│     │  → 実際の Join クエリを生成                  │         │
│     └─────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  6. Join 実行                                                │
│                                                              │
│  Index Structure:                                            │
│  ┌──────────────────────────────────────────────┐           │
│  │ Parent: company_1 (ordinal: 100)             │           │
│  │   ├─ Child: employee_1 (dept: Eng) ✓         │           │
│  │   └─ Child: employee_2 (dept: Sales) ✗       │           │
│  │                                               │           │
│  │ Parent: company_2 (ordinal: 101)             │           │
│  │   ├─ Child: employee_3 (dept: Eng) ✓         │           │
│  │   └─ Child: employee_4 (dept: Eng) ✓         │           │
│  │                                               │           │
│  │ Parent: company_3 (ordinal: 102)             │           │
│  │   └─ Child: employee_5 (dept: Sales) ✗       │           │
│  └──────────────────────────────────────────────┘           │
│                                                              │
│  Result: company_1 ✓, company_2 ✓, company_3 ✗             │
└─────────────────────────────────────────────────────────────┘
```



## 図3: Bool Query と Nested/Has_Child の組み合わせ

```
┌─────────────────────────────────────────────────────────────────┐
│              Bool Query + Nested の実行フロー                    │
└─────────────────────────────────────────────────────────────────┘

Query:
{
  "bool": {
    "must": [
      { "term": { "status": "active" } },      ← 親フィールド
      { "nested": {
          "path": "items",
          "query": { "term": { "items.name": "laptop" } }
        }
      }
    ]
  }
}

実行フロー:
┌─────────────────────────────────────────────────────────────────┐
│  1. Bool Query の構築                                            │
│     BooleanQuery.Builder builder = new BooleanQuery.Builder()  │
└─────────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────────┐
        ▼                                       ▼
┌──────────────────────┐          ┌──────────────────────────────┐
│  Must Clause 1       │          │  Must Clause 2               │
│  TermQuery           │          │  NestedQuery                 │
│  (status: active)    │          │  ┌────────────────────────┐  │
│                      │          │  │ ToParentBlockJoinQuery │  │
│  → 親ドキュメント     │          │  │ (items.name: laptop)   │  │
│     レベルで実行      │          │  └────────────────────────┘  │
└──────────────────────┘          └──────────────────────────────┘
        │                                       │
        └───────────────────┬───────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. AND 結合 (BooleanQuery with MUST)                           │
│                                                                  │
│  Document Evaluation:                                            │
│  ┌────────────────────────────────────────────────────┐         │
│  │ Doc 1: status=active, items=[{name: laptop}]      │ ✓       │
│  │        Clause1: ✓  Clause2: ✓  → Match            │         │
│  │                                                     │         │
│  │ Doc 2: status=inactive, items=[{name: laptop}]    │ ✗       │
│  │        Clause1: ✗  Clause2: ✓  → No Match         │         │
│  │                                                     │         │
│  │ Doc 3: status=active, items=[{name: phone}]       │ ✗       │
│  │        Clause1: ✓  Clause2: ✗  → No Match         │         │
│  └────────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## 図4: スコア集約モードの動作

```
┌─────────────────────────────────────────────────────────────────┐
│                  ScoreMode の動作比較                            │
└─────────────────────────────────────────────────────────────────┘

Parent Document with 3 matching children:
┌──────────────────────────────────────────────────────────────┐
│  Parent: company_1                                            │
│    ├─ Child 1: score = 2.5                                   │
│    ├─ Child 2: score = 3.0                                   │
│    └─ Child 3: score = 1.5                                   │
└──────────────────────────────────────────────────────────────┘

ScoreMode の計算:

┌──────────────┬─────────────────────────────────────────────┐
│  ScoreMode   │  Parent Score                               │
├──────────────┼─────────────────────────────────────────────┤
│  None        │  1.0 (固定)                                 │
│              │  → スコアを考慮しない                        │
├──────────────┼─────────────────────────────────────────────┤
│  Avg         │  (2.5 + 3.0 + 1.5) / 3 = 2.33              │
│              │  → 平均スコア                                │
├──────────────┼─────────────────────────────────────────────┤
│  Sum (Total) │  2.5 + 3.0 + 1.5 = 7.0                     │
│              │  → 合計スコア                                │
├──────────────┼─────────────────────────────────────────────┤
│  Max         │  max(2.5, 3.0, 1.5) = 3.0                  │
│              │  → 最大スコア                                │
├──────────────┼─────────────────────────────────────────────┤
│  Min         │  min(2.5, 3.0, 1.5) = 1.5                  │
│              │  → 最小スコア                                │
└──────────────┴─────────────────────────────────────────────┘
```

## 図5: データ構造の比較

```
┌─────────────────────────────────────────────────────────────────┐
│              Nested vs Parent-Child の違い                       │
└─────────────────────────────────────────────────────────────────┘

【Nested Object】
Lucene Document Structure (Block Join):
┌────────────────────────────────────────┐
│ Document Block (同一セグメント内)       │
│ ┌────────────────────────────────────┐ │
│ │ Parent Doc (ID: 1)                 │ │
│ │   field1: "value"                  │ │
│ │   _type: "parent"                  │ │
│ ├────────────────────────────────────┤ │
│ │ Nested Child 1                     │ │
│ │   nested.field: "child1"           │ │
│ │   _type: "nested"                  │ │
│ ├────────────────────────────────────┤ │
│ │ Nested Child 2                     │ │
│ │   nested.field: "child2"           │ │
│ │   _type: "nested"                  │ │
│ └────────────────────────────────────┘ │
└────────────────────────────────────────┘
特徴:
- 親子が物理的に隣接
- 高速な Join 処理
- 更新時は親子全体を再インデックス

【Parent-Child】
Lucene Document Structure (Separate Documents):
┌────────────────────────────────────────┐
│ Parent Document (ID: 1)                │
│   company_name: "Company A"            │
│   _id: "company_1"                     │
│   join_field: "company"                │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ Child Document 1 (ID: 2)               │
│   employee_name: "John"                │
│   _id: "emp_1"                         │
│   join_field: {                        │
│     name: "employee",                  │
│     parent: "company_1"                │
│   }                                    │
└────────────────────────────────────────┘

┌────────────────────────────────────────┐
│ Child Document 2 (ID: 3)               │
│   employee_name: "Jane"                │
│   _id: "emp_2"                         │
│   join_field: {                        │
│     name: "employee",                  │
│     parent: "company_1"                │
│   }                                    │
└────────────────────────────────────────┘

特徴:
- 親子が独立したドキュメント
- 子の個別更新が可能
- OrdinalMap を使用した Join
- Nested より Join コストが高い
```
