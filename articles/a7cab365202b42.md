---
title: "OpenSearch 3.0 の Live Queries によるリアルタイムクエリ監視"
emoji: "🔍"
type: "tech"
topics:
  - "opensearch"
published: false
---

OpenSearch Query Insights は検索クエリのパフォーマンスを理解するための重要なツールです。クエリがどのように実行され、クラスターリソースを消費するかを可視性とともに提供しています。パフォーマンスのボトルネックを特定し、検索操作の最適化を手助けするという私たちのコミットメントに基づき、OpenSearch 3.0 の強力な新機能である **Live Queries** をご紹介できることを嬉しく思います。

上位 N クエリの履歴分析はトレンドや過去の問題を理解するのに役立ちますが、*今まさに* 何が起こっているかを正確に知る必要がある場合があります。特定のクエリが時間をかけすぎているのか？リソース消費の急激な増加が特定の検索アクティビティに関連しているのか？ライブクエリを使用することで、このような即座の洞察を得ることができます。

## Live Queries とは？

OpenSearch 3.0 で導入された Live Queries は、クラスターの検索ワークロードの現在の状態を調査することを可能にします。Live Queries API は、クラスター全体または特定のノードで現在実行中の検索クエリのリストを取得します。この機能はクエリの動作をリアルタイムで可視化し、特に以下のタスクを実行する際に有用です：

*   **問題のあるクエリの特定**: 予想外に長時間実行されているクエリを素早く発見します。
*   **リソースを大量消費するクエリのデバッグ**: *まさにこの瞬間* に大量の CPU やメモリを消費している検索を特定します。
*   **即座のクラスター負荷の理解**: クラスターに影響を与えている現在の検索アクティビティのスナップショットを取得します。

API は各ライブクエリの主要な詳細を返します。これには、そのソース、検索タイプ、関与するインデックス、実行されているノード ID、開始時刻、現在のレイテンシ、およびその時点までのリソース使用量(コーディネーターノード上)が含まれます。

## ライブクエリの仕組み

以下の REST API エンドポイントを使用してライブクエリ情報にアクセスできます：

```json
GET /_insights/live_queries
```

デフォルトでは、API は現在実行中の検索クエリのリストを `latency` の降順でソートして返します。

### 返される主要情報

各ライブクエリについて、豊富なデータセットを受け取ります：

*   `timestamp`: クエリタスクが開始された時刻(エポックからのミリ秒)。
*   `id`: 一意の検索タスク ID。
*   `description`: 対象インデックス、検索タイプ、クエリソース自体(`verbose` が true の場合)を含むクエリの詳細。
*   `node_id`: クエリタスクが実行されているコーディネーターノードの ID。
*   `measurements`: これまでに収集されたパフォーマンスメトリクスを含むオブジェクト：
    *   `latency`: 現在の実行時間(ナノ秒)。
    *   `cpu`: これまでに消費された CPU 時間(ナノ秒)。
    *   `memory`: これまでに使用されたヒープメモリの量(バイト)。

## ライブクエリの使い始め方

Live Queries API との相互作用は簡単です。API は以下の操作をサポートしています。

### 基本的なリクエスト

レイテンシでソートされた現在実行中のクエリのリストを取得するには、以下のリクエストを送信します：

```json
GET /_insights/live_queries
```

### クエリパラメータを使用したビューのカスタマイズ

以下のオプションパラメータを使用して Live Queries API のレスポンスを調整できます：
- `verbose`: クエリソースなどの詳細なクエリ情報を含めます。
- `nodeId`: カンマ区切りのノード ID リストで結果をフィルタリングします。
- `sort`: レイテンシ、CPU 使用量、メモリ使用量などの特定のメトリクスで結果をソートします。
- `size`: 返されるクエリレコードの数を制限します。

### 例: CPU 集約的なライブクエリの検索

現在最も多くの CPU を消費している上位 5 つのクエリを見つけるには、以下のクエリパラメータを提供できます：

```json
GET /_insights/live_queries?verbose=false&sort=cpu&size=5
```

### レスポンスの理解

レスポンスがどのようなものかの例を以下に示します([ドキュメントの例](https://docs.opensearch.org/docs/latest/observing-your-data/query-insights/live-queries/#example-response)から取得、簡潔にするため 1 つのクエリのみ表示)：

```json
{
  "live_queries" : [
    {
      "timestamp" : 1745359226777,
      "id" : "troGHNGUShqDj3wK_K5ZIw:512",
      "description" : "indices[my-index-*], search_type[QUERY_THEN_FETCH], source[{\\\"size\\\":20,\\\"query\\\":{\\\"term\\\":{\\\"user.id\\\":{\\\"value\\\":\\\"userId\\\",\\\"boost\\\":1.0}}}}]",
      "node_id" : "troGHNGUShqDj3wK_K5ZIw",
      "measurements" : {
        "latency" : {
          "number" : 13959364458,
          "count" : 1,
          "aggregationType" : "NONE"
        },
        "memory" : {
          "number" : 3104,
          "count" : 1,
          "aggregationType" : "NONE"
        },
        "cpu" : {
          "number" : 405000,
          "count" : 1,
          "aggregationType" : "NONE"
        }
      }
    }
    // ... その他のライブクエリ
  ]
}
```

このレスポンスは以下の情報を提供します：

*   クエリはタイムスタンプ `1745359226777` で開始されました。
*   ノード `troGHNGUShqDj3wK_K5ZIw` で実行されています。
*   これまでのところ、13.9 秒以上実行されています(`latency.number` はナノ秒)。
*   `405000` ナノ秒の CPU 時間と `3104` バイトのメモリを消費しています。
*   `description`(リクエストで `verbose=true` のため提供)は、クエリが `my-index-*` を対象とし、実際のクエリ構造を含むことを示しています。

## ライブクエリが重要な理由

ライブクエリを監視する能力は重要な利点を提供します：

*   **即座のトラブルシューティング**: ユーザーが遅さを報告したり、ダッシュボードが高負荷を示したりした場合、ライブクエリを使用することでアクティブな検索の即座のビューを提供します。これにより、特定のクエリまたはクエリのパターンが原因かどうかを素早く特定できます。
*   **プロアクティブなパフォーマンス管理**: 特にピーク時にライブクエリを時々チェックすることで、広範囲な問題を引き起こす前に潜在的に問題のあるクエリを発見できます。
*   **リソース消費の洞察**: どのライブクエリが最も多くの CPU やメモリを消費しているかを理解することで、リアルタイムのリソース評価に役立ち、必要に応じて暴走クエリをキャンセルするなどの即座のアクションを導くことができます(ただし、キャンセル自体は別の OpenSearch Task Management API 機能です)。

## まとめ

OpenSearch 3.0 の新しいライブクエリ機能は、クラスターの現在の検索ワークロードをリアルタイムで可視化することで、クエリパフォーマンス監視に重要な次元を追加します。これにより、パフォーマンスの問題をより迅速に診断・対処でき、ユーザーにとってよりスムーズで効率的な検索体験を確保できます。

上位 N クエリ分析や履歴データエクスポートなどの Query Insights の既存機能と組み合わせることで、ライブクエリは OpenSearch 環境を管理・最適化するための包括的なツールキットを提供します。

ライブクエリを使い始めるには、OpenSearch 3.0 にアップグレードしてください。詳細については、[ライブクエリ](https://opensearch.org/docs/latest/observing-your-data/query-insights/live-queries/)および、より広範な[クエリインサイトドキュメント](https://opensearch.org/docs/latest/observing-your-data/query-insights/index/)をご覧ください。

この新機能を探索し、[OpenSearch フォーラム](https://forum.opensearch.org/)で体験やフィードバックを共有していただくことをお勧めします。
