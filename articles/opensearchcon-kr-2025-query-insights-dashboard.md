---
title: "OpenSearchCon Korea 2025: Query Insights ダッシュボードをマスターする"
emoji: "🔍"
type: "tech"
topics: ["opensearch", "observability", "monitoring", "performance", "dashboard"]
published: false
---

:::message
本記事は [OpenSearch Project YouTube チャンネル](https://www.youtube.com/@OpenSearchProject) で公開されているセッション動画の内容を日本語で書き起こしたものです。
:::

**イベント**: [OpenSearchCon Korea 2025](https://www.youtube.com/playlist?list=PLzgr9zSpws16DPeI08ZXYQI2zz-EuJfyA)
**プレゼンター**: David Zane & Chenyang Ji, Amazon Web Services

https://www.youtube.com/watch?v=KHti7pl6w5I

※ 本記事は動画の自動字幕を基に作成しています。誤字脱字や誤った内容が含まれる可能性があります。

## はじめに

このセッションでは、OpenSearch の Query Insights ダッシュボードについて、その新機能とコア機能を中心に実践的な使い方を解説します。Query Insights は、検索パフォーマンスの可視化と最適化を支援する包括的なフレームワークです。

## 本編

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_5.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=5)

### Query Insights とは何か、なぜ構築しているのか

皆さん、こんにちは。本日の OpenSearch Query Insights に関するセッションへようこそ。私は Chenyang で、こちらは David です。私たちは主に OpenSearch の検索レジリエンシー、パフォーマンス、オブザーバビリティに取り組んでおり、Query Insights とそれに対応するダッシュボードプラグインのメンテナーでもあります。

本日は Query Insights の概要をお伝えしたいと思います。私たちが何を実現しようとしているのか、なぜそれが重要なのかをカバーします。また、昨年から開発してきたユースケースと機能、そして今後の計画についてもお話しします。このセッションを通じて、OpenSearch ユーザーや検索エンジニアの皆さんが、Query Insights がどのように役立つかを理解していただければ幸いです。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_50.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=50)

### 管理者が直面する課題

検索は OpenSearch のコアユースケースですよね。当然、私たちは検索クエリを高速かつ効率的にしたいと考えています。しかし、ここで問題があります。これは実際に管理者ユーザーや検索エンジニアから繰り返し聞いていることです。

彼らは検索パフォーマンスで何が起きているのかを理解しようと本当に苦労しています。彼らが直面している状況を描いてみましょう。あなたが管理者ユーザーで、突然クラスターが遅くなったとします。どうしますか？

現状では、ある意味盲目的に飛んでいるようなものです。スローログに頼ることはできますが、「過去 1 時間でどのクエリがすべてのリソースを消費しているのか」「誰がこれらの遅いクエリを送信しているのか」「クエリが遅いと言うとき、具体的にどこが遅いのか - クエリフェーズなのか、フェッチフェーズなのか、それとも他の何かなのか」といった基本的な質問に簡単に答えることができません。

これらは単なる「あったらいいな」という洞察ではありません。管理者ユーザーが毎日答えを必要とする非常に重要な質問です。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_170.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=170)

### Query Insights が解決する問題

これが Query Insights で解決しようとしているコアの問題です。私たちはクエリ実行のあらゆる段階で詳細なメトリクスをキャプチャする包括的なフレームワークを構築しています。そして、これらのメトリクスを非同期で処理し、類似したメトリクスをグループ化してパターンを特定し、API とダッシュボードを通じてこれらのパターンとメトリクスを表示します。

ここでの究極の目標は、人々が OpenSearch で検索パフォーマンスを管理する方法を変革することです。問題が発生した後やユーザーからの苦情の後に慌てて修正するのではなく、問題になる前に問題を発見できるようになります。どのクエリを最適化すべきか、どのユーザーと話すべきか、どこに最適化の努力を集中すべきかがわかるようになります。

私たちは OpenSearch 2.12 以降、これを段階的にリリースしてきました。これまでに構築したものをお見せしたいと思います。先ほど述べたように、Query Insights はバックエンドとフロントエンドのプラグインで構成されています。両方をインストールすると、API またはダッシュボードで使用できます。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_300.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=300)

### 設定ページ

まずダッシュボードの設定ページを説明します。このページでは、Query Insights が何を追跡するかを正確に制御できます。

まず、メトリクスを選択できます。レイテンシー、CPU 使用率、メモリ消費量のどれに興味がありますか？それぞれがクエリについて異なるストーリーを教えてくれます。

次にウィンドウサイズがあります。これはローリングタイムウィンドウです。5 分に設定すると、5 分ごとのトップクエリを追跡します。1 時間に設定すると、より広い視野が得られます。

そしてトップサイズがあります。これは Query Insights が各タイムウィンドウで何件のクエリを保持するかを決定します。10 に設定すると、Query Insights は最後のウィンドウの最悪の 10 件のクエリまたはシェイプを追跡します。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_360.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=360)

### クエリグルーピング機能

私たちが追加した本当にクールな機能の 1 つがクエリグルーピングです。同じ悪いクエリが何度も実行されることがあり、突然同じクエリがトップクエリ概要ページ全体を占めてしまうことがあります。

グルーピングを有効にすると、これらのクエリを類似または同じパターンとしてグループとして扱うことができます。グループ化することで、すべての個別のクエリではなく、これらの問題のあるクエリのパターンを簡単に確認できます。

また、ユーザーが Query Insights やトップクエリデータをシンクにエクスポートできるようにしています。例えば、エクスポーターのタイプや保持ポリシーを設定できます。David が後でこれについて詳しく説明します。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_430.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=430)

### 概要ページとクエリ詳細

設定が完了したら、概要ページに移動できます。一目で、レイテンシー、CPU、メモリのいずれかで最もコストのかかるクエリを確認できます。各行には CPU 時間、メモリ使用量、レイテンシー、インデックス、総シャード数、関係するコーディネーターノードが表示されます。これらのメトリクスでフィルタリングやソートができます。

例えば、突然 CPU スパイクが発生した場合、CPU でソートするだけで、どのクエリが原因かを確認できます。

特定のクエリをクリックすると、完全なストーリーが得られます。レイテンシーをフェーズごとに分解します。この場合、このクエリはクエリフェーズで長い時間を費やしていますが、フェッチでは比較的短い時間です。これにより、最適化の努力をどこに集中すべきかがわかります。

グルーピングを有効にすると、概要ページでは個別のクエリではなく、各行が類似クエリのグループを表します。表示されるレイテンシー、CPU、メモリ使用量の数値は、グループ全体の平均です。詳細ページでもすべての平均が表示され、さらにこのグループの代表的な例が表示されるので、これらのクエリが実際に何をしているかをより理解できます。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_500.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=500)

### ライブクエリページ

3.1 で導入したライブクエリページについてお話しします。Andrew も彼のスライドでこれについて触れていました。これらはクラスターで現在実行中のクエリです。

誰かが「私の OpenSearch クラスターが今遅い」と言った場合、ノード別、インデックス別に長時間実行中のクエリを確認でき、これらのクエリの詳細を見て、必要に応じてキャンセルすることもできます。

これらすべての素晴らしい点は、OpenSearch ディストリビューションですぐに使えることです。プラグインをインストールし、追跡したいものを設定するだけで、可視性が得られます。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_600.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=600)

### API について

Query Insights には 3 つの API があります。1 つ目はトップクエリ、2 つ目はライブクエリです。これら 2 つの API がダッシュボードで見たデータを提供します。これらの API には追加のクエリパラメータがありますが、これが基本的な API パスです。

3 つ目の API はヘルスステータスです。この API は Query Insights プラグインに関する貴重なデバッグ情報を提供します。ただし、このデータは主にデバッグ目的で使用されるため、ダッシュボードには表示しません。

設定については、すべての Query Insights 設定は動的なクラスター設定です。これはレイテンシーウィンドウサイズを更新するための REST リクエストの例です。ただし、Query Insights ダッシュボードにアクセスできる場合は、そこから設定を更新する方がはるかに簡単です。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_690.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=690)

### トップクエリ機能のアーキテクチャ

トップクエリ機能のアーキテクチャについて説明します。この機能の目標は、レイテンシーの観点で最も長時間実行されているクエリと、CPU とメモリの観点で最もリソース集約的なクエリを追跡・記録することです。

検索リクエストがドメインで完了すると、まずこの Query Insights リクエストバッファに挿入されます。このリクエストバッファのエントリには、元の検索クエリに加えて、総レイテンシー、CPU とメモリ使用量、そしてダッシュボードテーブルで見た検索タイプやコーディネーターノードなどの他の属性が含まれます。

5 秒ごとに、リクエストバッファは 3 つの優先度キューにドレインされます。レイテンシー、CPU、メモリそれぞれに 1 つの優先度キューがあります。リクエストが現在優先度キューにある最小のレイテンシー、CPU、またはメモリを超えると、優先度キューに挿入されます。そうでなければ、そのリクエストは無視されます。

これらの優先度キューのサイズは、ドメインで設定したクラスター設定に基づいて n です。デフォルトでは n は 10 で、各メトリクスタイプごとに異なる n を設定できます。

現在のタイムウィンドウが期限切れになると（デフォルトでは 5 分）、優先度キューのすべてのデータが設定したシンクにエクスポートされます。また、優先度キューはクリアされ、次のタイムウィンドウのためにプロセスが再開されます。

このリクエストバッファを使用したアーキテクチャにより、リクエストを非同期で処理できるため、Query Insights の処理がボトムラインのレイテンシーに影響しません。

[![Thumbnail](/images/opensearchcon-kr-2025-query-insights-dashboard/thumbnail_800.jpg)](https://www.youtube.com/watch?v=KHti7pl6w5I&t=800)

### トップクエリデータのエクスポート

Query Insights は 3 つのエクスポートオプションを提供しています：none、debug、local index です。debug はデータをログに書き込み、local index はドメイン上のインデックスにデータを書き込みます。local index がデフォルトのエクスポーターです。

これにより、トップクエリデータが画面上の命名パターン（top_queries_年月日_ハッシュコード）でインデックスに保存されます。ハッシュコードは 5 桁の数字です。これにより、過去のトップクエリデータをクエリできます。この情報を保持して、数日後や数週間後に確認できます。

エクスポーターには delete_after 設定があります。これは local index に適用され、何日分のデータを保持するかを指定します。デフォルトは 7 日ですが、最大 180 日まで設定できます。また、Query Insights はこれらのローカルインデックスの作成、削除、インデックスパターンなどすべてを管理します。

### 今後の計画

Query Insights のロードマップには多くの項目がありますが、4 つを紹介したいと思います。

1 つ目はライブクエリのシャードタスクです。現在、ライブクエリダッシュボードはリクエストレベルのデータのみを表示します。これをシャードレベルのデータを含むように拡張し、ドメイン上の長時間実行クエリについてさらに詳細な洞察を得られるようにしたいと考えています。

2 つ目はトップクエリの追加エクスポーターです。現在 3 つのエクスポーターオプションを提供していますが、ユーザーから S3 や Prometheus などの他のエクスポーターへの関心が寄せられています。

3 つ目はワークロード管理との統合です。ワークロード管理は OpenSearch のレジリエンシー機能で、特定のクエリグループにリソース制限を課すことができます。ワークロード管理が有効になると、すべてのリクエストにワークロードグループが割り当てられます。このワークロードグループを Query Insights レコードの属性として追加し、ダッシュボードに表示することで、長時間実行クエリや高リソース使用クエリがどのグループに関連しているかがわかるようにしたいと考えています。

4 つ目は Profile API ビジュアライザーです。Profile API は OpenSearch のデバッグツールで、遅いクエリがどこで時間を費やしているかを特定するのに役立ちます。この API の出力は非常に冗長で、非常に長い JSON オブジェクトです。Query Insights ダッシュボードにビジュアライザーを追加することは、この出力を理解するための非常に価値のある機能になるでしょう。

### Q&A セッション

**Q: OpenSearch Benchmark との統合計画はありますか？**

A: それは実際に非常に興味深い考えです。Query Insights は主に現在実行中のクエリや過去数時間の履歴に焦点を当てているため、まだ考えていませんでした。実際に OpenSearch Benchmark を使用して OpenSearch クラスターに対してテストし、Query Insights がインストールされていれば、これらの結果は得られますが、ベンチマーク専用の画面やサポートはありません。他のクエリと同様に扱われます。

**Q: すべてのクラスターでこの機能を有効にしたいのですが、追加リソースが必要になることが心配です。何かアドバイスはありますか？**

A: 1,200 クラスターは多いですね。ワークロードによりますが、まず 1 つのメトリクス（例えばレイテンシーで追跡）から始めることをお勧めします。n を小さい数（例えば 10 や 5）に設定して始め、少し実験してみてください。ウィンドウサイズについては、ユースケースによりますが、1 時間をお勧めします。そうすれば、1 時間ごとのトップ 10 クエリを取得できます。それが良い出発点になるはずです。

## まとめ

Query Insights は、OpenSearch の検索パフォーマンスを可視化し、問題を事前に発見するための強力なツールです。設定ページでメトリクス、ウィンドウサイズ、トップサイズを設定し、概要ページでトップクエリを確認、詳細ページでフェーズごとのレイテンシー分解を確認できます。ライブクエリ機能により、リアルタイムで実行中のクエリを監視し、必要に応じてキャンセルすることも可能です。

詳細については、以下のリポジトリと OpenSearch ドキュメントを参照してください：
- [OpenSearch Query Insights](https://github.com/opensearch-project/OpenSearch/tree/main/plugins/query-insights)
- [OpenSearch Dashboards Query Insights](https://github.com/opensearch-project/OpenSearch-Dashboards/tree/main/src/plugins/query_insights)
