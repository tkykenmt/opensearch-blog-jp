---
title: "OpenSearch ã«ãŠã‘ã‚‹æœ€æ–°ã®ã‚·ãƒ£ãƒ¼ãƒ‰é…ç½®æˆ¦ç•¥ã«ã¤ã„ã¦"
emoji: "ğŸ‘"
type: "tech"
topics: ["opensearch", "sharding", "architecture"]
published: true
published_at: "2023-01-16 22:27"
---

Amazon OpenSearch Service ã«ãŠã„ã¦ã€å…ˆæ—¥ã‚·ãƒ£ãƒ¼ãƒ‰é…ç½®æˆ¦ç•¥ã«é–¢ã™ã‚‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒæœ‰ã‚Šã¾ã—ãŸã€‚

https://aws.amazon.com/jp/blogs/news/impact-of-infrastructure-failures-on-shard-in-amazon-opensearch-service/

ä¸»ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå†…å®¹ã¯ä»¥ä¸‹ã® 2 ã¤ã®ä»•çµ„ã¿ã®å°å…¥ã§ã™

1. Forced Zone Awareness ã«ã‚ˆã‚‹ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚¾ãƒ¼ãƒ³é–“ã®ã‚·ãƒ£ãƒ¼ãƒ‰ç§»å‹•ã®æŠ‘æ­¢
2. Load-Aware Shard Allocation ã«ã‚ˆã‚‹ç‰¹å®šãƒãƒ¼ãƒ‰ã¸ã®ã‚·ãƒ£ãƒ¼ãƒ‰éç©è¼‰ã®æŠ‘æ­¢

å„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®æ¦‚è¦ã¨ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã«ã‚ˆã‚‹æŒ™å‹•ã®å¤‰åŒ–ã«ã¤ã„ã¦ã¯ AWS å…¬å¼ Blog ã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æœ¬è¨˜äº‹ã§ã¯ã“ã‚Œã‚‰ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å®Ÿè£…ãƒ¬ãƒ™ãƒ«ã§è¦‹ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

# Forced Zone Awareness

## Forced Zone Awareness ã®æ¦‚è¦
Forced Zone Awarenss ã«ã¤ã„ã¦ã€Blog å†…ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è§£èª¬ã•ã‚Œã¦ã„ã¾ã™

> OpenSearch ã«ã¯ã€ã‚·ãƒ£ãƒ¼ãƒ‰ã‚’å‰²ã‚Šå½“ã¦ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ¼ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹ã€forced awareness ã¨å‘¼ã°ã‚Œã‚‹æ—¢å­˜ã®ã‚·ãƒ£ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°è¨­å®šãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€zoneã¨ã„ã† awareness å±æ€§ãŒã‚ã‚Šã€zone1 ã¨ zone2 ã«ãƒãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã„ã‚‹å ´åˆã€forced awareness æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ä½¿ç”¨å¯èƒ½ãªã‚¾ãƒ¼ãƒ³ãŒ1ã¤ã—ã‹ãªã„å ´åˆã«OpenSearchãŒãƒ¬ãƒ—ãƒªã‚«ã‚’å‰²ã‚Šå½“ã¦ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
cluster.routing.allocation.awareness.attributes: zone
cluster.routing.allocation.awareness.force.zone.values: zone1,zone2
```

>ã“ã®æ§‹æˆä¾‹ã§ã¯ã€node.attr.zone ã‚’ zone1 ã«è¨­å®šã—ã¦ 2 ã¤ã®ãƒãƒ¼ãƒ‰ã‚’èµ·å‹•ã—ã€5 ã¤ã®ã‚·ãƒ£ãƒ¼ãƒ‰ã¨ 1 ã¤ã®ãƒ¬ãƒ—ãƒªã‚«ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹ã¨ã€OpenSearch ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ 5 ã¤ã®ãƒ—ãƒ©ã‚¤ãƒãƒªã‚·ãƒ£ãƒ¼ãƒ‰ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ãŒã€ãƒ¬ãƒ—ãƒªã‚«ã¯å‰²ã‚Šå½“ã¦ã¾ã›ã‚“ã€‚ãƒ¬ãƒ—ãƒªã‚«ã¯ã€node.attr.zone ãŒ zone2 ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ãŒä½¿ç”¨å¯èƒ½ã«ãªã£ãŸã¨ãã«ã®ã¿å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚

OpenSearch ã¯ãƒãƒ¼ãƒ‰ã«ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚`opensearch.yml` å†…ã§è¨­å®šã™ã‚‹ã€ãªã„ã—ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•æ™‚ã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

https://github.com/opensearch-project/OpenSearch/blob/2.3/distribution/src/config/opensearch.yml#L25-L28

ã“ã“ã§æŒ‡å®šã—ãŸã‚«ã‚¹ã‚¿ãƒ å±æ€§ã¯ã€Allocation Awareness ã®è¨­å®šå†…ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
`cluster.routing.allocation.awareness.attributes` ã§æŒ‡å®šã—ãŸ `zone` ã¯ã€`node.attr.zone` ã¨ã„ã†ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚’å®šç¾©ã—ã¦åˆã‚ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ã‘ã§ã™ã€‚

ã¾ãŸ `cluster.routing.allocation.awareness.force.zone.values` ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚‚ã€`cluster.routing.allocation.awareness.attributes` ã§ `zone` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§åˆã‚ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ã‘ã§ã™ã€‚ä»®ã« `cluster.routing.allocation.awareness.attributes` ã§ã€€`rack` ã¨æŒ‡å®šã—ã¦ã„ãŸå ´åˆã€Forced Awarenss ã§åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ `cluster.routing.allocation.awareness.force.rack.values` ã¨ãªã‚Šã¾ã™ã€‚

ã•ã¦ã€ã“ã“ã§æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«æ§‹ç¯‰ã—ãŸ OpenSearch ãƒ‰ãƒ¡ã‚¤ãƒ³ã® `cluster.routing.allocation.awareness.force.zone.values` ã®è¨­å®šã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ã€6 ãƒãƒ¼ãƒ‰ãŒ 3 ã¤ã®ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚¾ãƒ¼ãƒ³ã«åˆ†æ•£é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚`ap-northeast-1a` `ap-northeast-1c` `ap-northeast-1d` ã® 3 ã¤ã®ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚¾ãƒ¼ãƒ³ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã­ã€‚

```
GET _cluster/settings?include_defaults&filter_path=persistent.cluster.routing.allocation.awareness
{
  "persistent" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : {
            "force" : {
              "zone" : {
                "values" : "ap-northeast-1a,ap-northeast-1c,ap-northeast-1d"
              }
            }
          }
        }
      }
    }
  },
  "transient" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : {
            "force" : {
              "zone" : {
                "values" : "ap-northeast-1a,ap-northeast-1c,ap-northeast-1d"
              }
            }
          }
        }
      }
    }
  },
  "defaults" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : {
            "balance" : "false"
          }
        }
      }
    }
  }
}
```

ã§ã¯ãƒãƒ¼ãƒ‰ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ node.attr.zone ã¯ã©ã†ãªã£ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨ã€Amazon OpenSearch Service ã§ã¯ _cat/nodeattrs API ã«è“‹ã‚’ã•ã‚Œã¦ã„ã¦ç¢ºèªã§ãã¾ã›ã‚“ã€‚API ã‚’å‘¼ã³å‡ºã™ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ãã¾ã™ã€‚

```
GET _cat/nodeattrs
{"Message":"Your request: '/_cat/nodeattrs' is not allowed."}
```

## Forced Zone Awareness ã®å‹•ä½œæ¤œè¨¼

Amazon OpenSearch Service ã«ã¯ä»»æ„ã®ãƒãƒ¼ãƒ‰ã‚’åœæ­¢ã™ã‚‹ã‚ˆã†ãªæ©Ÿèƒ½ã‚‚ç„¡ã„ãŸã‚ã€ã“ã®ã¾ã¾ã§ã¯ãƒãƒ¼ãƒ‰åœæ­¢æ™‚ã®å‹•ä½œæ¤œè¨¼ã‚‚é›£ã—ã„ã§ã™ã­ã€‚ãªã®ã§ã€ã“ã“ã‹ã‚‰ã¯ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã«æ§‹ç¯‰ã—ãŸ OpenSearch ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã« Amazon OpenSearch Service ã¨åŒæ§˜ã® Forced Awareness è¨­å®šã‚’è¿½åŠ ã—ã¦ã€ãƒãƒ¼ãƒ‰åœæ­¢æ™‚ã®å‹•ä½œã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

ã¯ã˜ã‚ã«ã€å„ãƒãƒ¼ãƒ‰ã® opensearch.yml ã«ä¸‹è¨˜ã®è¨­å®šã‚’è¿½åŠ ã—ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
node.attr.zone: ap-northeast-1a # è‡ªä¿¡ãŒæ‰€å±ã™ã‚‹ AZ ã«å¿œã˜ã¦å¤‰æ›´ã™ã‚‹
cluster.routing.allocation.awareness.attributes: zone
cluster.routing.allocation.awareness.force.zone.values: ["ap-northeast-1a", "ap-northeast-1c", "ap-northeast-1d"]
cluster.routing.allocation.awareness.balance: false
```

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã«ã¯ Blog ã®æ§‹æˆä¾‹ã¨åŒæ§˜ã€ 3 AZ ã« 2 ãƒãƒ¼ãƒ‰ãšã¤åˆ†æ•£ã—ã¦ãƒãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¾ã™ã€‚

> ç¾åœ¨ã®ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦:
ã‚·ãƒ£ãƒ¼ãƒ‰ã®ç·æ•°:12 ãƒ—ãƒ©ã‚¤ãƒãƒª + 24 ãƒ¬ãƒ—ãƒªã‚« = 36 ã‚·ãƒ£ãƒ¼ãƒ‰
ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ¼ã‚¾ãƒ¼ãƒ³ã®æ•°:3
ã‚¾ãƒ¼ãƒ³ã”ã¨ã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•° (zone awareness = true): 36/3 = 12
ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ¼ã‚¾ãƒ¼ãƒ³ã”ã¨ã®ãƒãƒ¼ãƒ‰æ•°:2
ãƒãƒ¼ãƒ‰ã‚ãŸã‚Šã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°:12/2 = 6

ç„¡äº‹ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒèµ·å‹•ã—ãŸã¨ã“ã‚ã§ã€ _cat/nodes ã¨ _cat/nodeattrs ã®å®Ÿè¡Œçµæœã‚’è¦‹ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```
GET _cat/nodes
10.101.102.99  31 50 0 0.00 0.00 0.00 dimr cluster_manager,data,ingest,remote_cluster_client - i-03bb5f9150c79f81c
10.101.101.207 55 49 0 0.00 0.00 0.00 dimr cluster_manager,data,ingest,remote_cluster_client - i-07f5d670bfd16ffc1
10.101.102.88  30 50 0 0.04 0.01 0.00 dimr cluster_manager,data,ingest,remote_cluster_client - i-02ebcae499eb258f0
10.101.103.176 66 50 0 0.00 0.00 0.00 dimr cluster_manager,data,ingest,remote_cluster_client * i-04a9961360c6f509e
10.101.103.40  14 49 0 0.00 0.00 0.00 dimr cluster_manager,data,ingest,remote_cluster_client - i-08063724f7ad84b48
10.101.101.119 33 49 0 0.01 0.01 0.00 dimr cluster_manager,data,ingest,remote_cluster_client - i-03e0f54e75ae6b746
```

```
GET _cat/nodeattrs?v
node                host           ip             attr value
i-03bb5f9150c79f81c 10.101.102.99  10.101.102.99  zone ap-northeast-1c
i-07f5d670bfd16ffc1 10.101.101.207 10.101.101.207 zone ap-northeast-1a
i-02ebcae499eb258f0 10.101.102.88  10.101.102.88  zone ap-northeast-1c
i-04a9961360c6f509e 10.101.103.176 10.101.103.176 zone ap-northeast-1d
i-08063724f7ad84b48 10.101.103.40  10.101.103.40  zone ap-northeast-1d
i-03e0f54e75ae6b746 10.101.101.119 10.101.101.119 zone ap-northeast-1a
```

ç¶šã„ã¦ã€å…¬å¼ Blog ã¨åŒã˜ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã€ãƒ¬ãƒ—ãƒªã‚«æ•°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œã£ã¦ã„ãã¾ã™

```
PUT sample-index
{
    "settings" : {
        "number_of_shards" : 12,
        "number_of_replicas" : 2
    }
}
```

ä½œæˆã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚·ãƒ£ãƒ¼ãƒ‰é…ç½®ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```
GET _cat/shards/sample-index?v
index        shard prirep state   docs store ip             node
sample-index 2     r      STARTED    0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 2     p      STARTED    0  208b 10.101.103.40  i-08063724f7ad84b48
sample-index 2     r      STARTED    0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 8     r      STARTED    0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 8     r      STARTED    0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 8     p      STARTED    0  208b 10.101.103.40  i-08063724f7ad84b48
sample-index 5     r      STARTED    0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 5     p      STARTED    0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 5     r      STARTED    0  208b 10.101.103.40  i-08063724f7ad84b48
sample-index 1     r      STARTED    0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 1     r      STARTED    0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 1     p      STARTED    0  208b 10.101.103.176 i-04a9961360c6f509e
sample-index 6     p      STARTED    0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 6     r      STARTED    0  208b 10.101.103.176 i-04a9961360c6f509e
sample-index 6     r      STARTED    0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 3     r      STARTED    0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 3     r      STARTED    0  208b 10.101.103.40  i-08063724f7ad84b48
sample-index 3     p      STARTED    0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 4     p      STARTED    0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 4     r      STARTED    0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 4     r      STARTED    0  208b 10.101.103.176 i-04a9961360c6f509e
sample-index 7     r      STARTED    0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 7     p      STARTED    0  208b 10.101.103.176 i-04a9961360c6f509e
sample-index 7     r      STARTED    0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 9     r      STARTED    0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 9     r      STARTED    0  208b 10.101.103.40  i-08063724f7ad84b48
sample-index 9     p      STARTED    0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 11    r      STARTED    0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 11    p      STARTED    0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 11    r      STARTED    0  208b 10.101.103.40  i-08063724f7ad84b48
sample-index 10    p      STARTED    0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 10    r      STARTED    0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 10    r      STARTED    0  208b 10.101.103.176 i-04a9961360c6f509e
sample-index 0     p      STARTED    0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 0     r      STARTED    0  208b 10.101.103.176 i-04a9961360c6f509e
sample-index 0     r      STARTED    0  208b 10.101.101.119 i-03e0f54e75ae6b746
```

sample-index ã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã‚’ãƒãƒ¼ãƒ‰ã”ã¨ã«é›†è¨ˆã™ã‚‹ã¨ã€ 6 ã‚·ãƒ£ãƒ¼ãƒ‰ãšã¤å‡ç­‰ã«åˆ†æ•£ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```
$ curl -s https://<ip-address>:9200/_cat/shards/sample-index -k -u <username>:<password> | awk '{print $7}' | sort | uniq -c
      6 10.101.101.119
      6 10.101.101.207
      6 10.101.102.88
      6 10.101.102.99
      6 10.101.103.176
      6 10.101.103.40
```

ã§ã¯ã€ãƒãƒ¼ãƒ‰éšœå®³æ™‚ã®å‹•ä½œã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
ã¾ãšã¯ ap-northeast-1d ä¸Šã® i-08063724f7ad84b48 ã‚’åœæ­¢ã—ã¾ã™ã€‚

åœæ­¢å¾Œã« _cat/nodes ã¨ _cat/nodeattrs ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€5 ãƒãƒ¼ãƒ‰æ§‹æˆã«ãªã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

```
GET _cat/nodes
10.101.102.99  35 50 0 0.12 0.05 0.02 dimr cluster_manager,data,ingest,remote_cluster_client - i-03bb5f9150c79f81c
10.101.101.207 58 49 0 0.00 0.00 0.00 dimr cluster_manager,data,ingest,remote_cluster_client - i-07f5d670bfd16ffc1
10.101.102.88  34 50 0 0.01 0.01 0.00 dimr cluster_manager,data,ingest,remote_cluster_client - i-02ebcae499eb258f0
10.101.103.176 17 50 0 0.00 0.00 0.00 dimr cluster_manager,data,ingest,remote_cluster_client * i-04a9961360c6f509e
10.101.101.119 37 49 0 0.08 0.02 0.01 dimr cluster_manager,data,ingest,remote_cluster_client - i-03e0f54e75ae6b746
```

```
GET _cat/nodeattrs

node                host           ip             attr value
i-03bb5f9150c79f81c 10.101.102.99  10.101.102.99  zone ap-northeast-1c
i-07f5d670bfd16ffc1 10.101.101.207 10.101.101.207 zone ap-northeast-1a
i-02ebcae499eb258f0 10.101.102.88  10.101.102.88  zone ap-northeast-1c
i-04a9961360c6f509e 10.101.103.176 10.101.103.176 zone ap-northeast-1d
i-03e0f54e75ae6b746 10.101.101.119 10.101.101.119 zone ap-northeast-1a
```

sample-index ã®ã‚·ãƒ£ãƒ¼ãƒ‰ã‚’ãƒãƒ¼ãƒ‰ã”ã¨ã«é›†è¨ˆã™ã‚‹ã¨ã€ap-northeast-1d ã«æ®‹ã£ãŸä¸€ã¤ã®ãƒãƒ¼ãƒ‰ã«ã‚·ãƒ£ãƒ¼ãƒ‰ãŒé›†ä¸­ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚Forced Zone Awareness ã«å‰‡ã£ã¦ã‚·ãƒ£ãƒ¼ãƒ‰ã®å†é…ç½®ãŒ AZ å†…ã«é–‰ã˜ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã­ã€‚

```
$ curl -s https://<ip-address>:9200/_cat/shards/sample-index -k -u <username>:<password> | awk '{print $7}' | sort | uniq -c
      6 10.101.101.119
      6 10.101.101.207
      6 10.101.102.88
      6 10.101.102.99
     12 10.101.103.176
``` 

è¿½åŠ ã§ã€ ap-northeast-1d ä¸Šã®ã‚‚ã†ä¸€ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚‹ i-04a9961360c6f509e ã‚’åœæ­¢ã—ã¾ã™ã€‚çµæœã€ä»¥ä¸‹ã®ã‚ˆã†ã« 12 ã®ã‚·ãƒ£ãƒ¼ãƒ‰ãŒæœªå‰²ã‚Šå½“ã¦ã¨ãªã‚Šã¾ã—ãŸã€‚Forced Awareness ã«ã‚ˆã£ã¦ã€ã‚¾ãƒ¼ãƒ³ã‚’ã¾ãŸãŒã£ã¦ã‚·ãƒ£ãƒ¼ãƒ‰ãŒå†é…ç½®ã•ã‚Œãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

```
index        shard prirep state      docs store ip             node
sample-index 4     p      STARTED       0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 4     r      STARTED       0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 4     r      UNASSIGNED
sample-index 6     p      STARTED       0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 6     r      STARTED       0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 6     r      UNASSIGNED
sample-index 2     p      STARTED       0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 2     r      STARTED       0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 2     r      UNASSIGNED
sample-index 3     r      STARTED       0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 3     p      STARTED       0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 3     r      UNASSIGNED
sample-index 8     p      STARTED       0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 8     r      STARTED       0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 8     r      UNASSIGNED
sample-index 9     r      STARTED       0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 9     p      STARTED       0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 9     r      UNASSIGNED
sample-index 10    p      STARTED       0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 10    r      STARTED       0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 10    r      UNASSIGNED
sample-index 5     r      STARTED       0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 5     p      STARTED       0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 5     r      UNASSIGNED
sample-index 11    r      STARTED       0  208b 10.101.102.99  i-03bb5f9150c79f81c
sample-index 11    p      STARTED       0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 11    r      UNASSIGNED
sample-index 7     p      STARTED       0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 7     r      STARTED       0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 7     r      UNASSIGNED
sample-index 1     p      STARTED       0  208b 10.101.101.207 i-07f5d670bfd16ffc1
sample-index 1     r      STARTED       0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 1     r      UNASSIGNED
sample-index 0     p      STARTED       0  208b 10.101.102.88  i-02ebcae499eb258f0
sample-index 0     r      STARTED       0  208b 10.101.101.119 i-03e0f54e75ae6b746
sample-index 0     r      UNASSIGNED
```

_cluster/allocation/explain API ã§æœªå‰²å½“ã®ã‚·ãƒ£ãƒ¼ãƒ‰ã¨ãªã£ã¦ã„ã‚‹ç†ç”±ã‚’ç¢ºèªã™ã‚‹ã¨ã€awareness ã® zone ã«åŸºã¥ãè¿½åŠ ã®ãƒ¬ãƒ—ãƒªã‚«ã¯å‰²ã‚Šå½“ã¦ãªã„ã¨åˆ¤æ–­ã•ã‚ŒãŸã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```
GET _cluster/allocation/explain

(...)
    {
      "node_id" : "25k4V2eYT7uPjFBqJNDtTQ",
      "node_name" : "i-02ebcae499eb258f0",
      "transport_address" : "10.101.102.88:9300",
      "node_attributes" : {
        "zone" : "ap-northeast-1c",
        "shard_indexing_pressure_enabled" : "true"
      },
      "node_decision" : "no",
      "deciders" : [
        {
          "decider" : "same_shard",
          "decision" : "NO",
          "explanation" : "a copy of this shard is already allocated to this node [[sample-index][2], node[25k4V2eYT7uPjFBqJNDtTQ], [P], s[STARTED], a[id=QDwizhfoTWKS_CQKckekOw]]"
        },
        {
          "decider" : "awareness",
          "decision" : "NO",
          "explanation" : "there are too many copies of the shard allocated to nodes with attribute [zone], there are [3]total configured shard copies for this shard id and [3] total attribute values, expected the allocated shard count per attribute [2] to be less than or equal to the upper bound of the required number of shards per attribute [1]"
        }
      ]
    },
(...)
```

ã“ã®å¾Œæ®µéšçš„ã«åœæ­¢ã—ãŸãƒãƒ¼ãƒ‰ã‚’èµ·å‹•ã—ã¦ã„ãã¨ã€ãƒãƒ¼ãƒ‰ã”ã¨ã®ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦æ•°ã¯åœæ­¢å‰ã®çŠ¶æ…‹ã«æˆ»ã‚Šã¾ã—ãŸã€‚

**i-04a9961360c6f509eèµ·å‹•å¾Œ**
```
$ curl -s https://<ip-address>:9200/_cat/shards/sample-index -k -u <username>:<password> | awk '{print $7}' | sort | uniq -c
      6 10.101.101.119
      6 10.101.101.207
      6 10.101.102.88
      6 10.101.102.99
     12 10.101.103.176
```

**i-08063724f7ad84b48èµ·å‹•å¾Œ**
```
$ curl -s https://<ip-address>:9200/_cat/shards/sample-index -k -u <username>:<password> | awk '{print $7}' | sort | uniq -c
      6 10.101.101.119
      6 10.101.101.207
      6 10.101.102.88
      6 10.101.102.99
      6 10.101.103.176
      6 10.101.103.40
```

## ç–‘å•ç‚¹
ã“ã“ã¾ã§ã®æ¤œè¨¼ã§ã€å…¬å¼ Blog ã§ã„ã†æ‰€ã® "Forced Zone Awareness" ã®å¤§ã¾ã‹ãªå‹•ä½œã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚

ãŸã ã€å…¬å¼ã®è§£èª¬ã«ã‚ˆã‚Œã°ä»¥ä¸‹ã®ã‚ˆã†ã«å˜ä¸€ãƒãƒ¼ãƒ‰éšœå®³ã§ã‚‚ã‚·ãƒ£ãƒ¼ãƒ‰ã®å†é…ç½®ã¯è¡Œã‚ã‚Œãªã„ã¯ãšã§ã™ã­ã€‚

![](https://storage.googleapis.com/zenn-user-upload/7a73d4decfc7-20230112.png)

ã—ã‹ã—ãªãŒã‚‰ã€ Forced Awareness ã‚’è¨­å®šã™ã‚‹ã ã‘ã§ã¯ã€å˜ä¸€ãƒãƒ¼ãƒ‰éšœå®³æ™‚ã«ã‚·ãƒ£ãƒ¼ãƒ‰ã®å†é…ç½®ãŒ AZ å†…ã§èµ°ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ä½•æ•…ã§ã—ã‚‡ã†ã‹ï¼Ÿ ã“ã®çµæœã«ã¯ã€æ¬¡ã«èª¬æ˜ã™ã‚‹ Load Aware Shard Allocation ãŒé–¢ä¿‚ã—ã¦ã„ã¾ã™ã€‚

# Load Aware Shard Allocation

## Load Aware Shard Allocation æ¦‚è¦
Load Aware Shard Allocation ã«ã¤ã„ã¦ã¯å…¬å¼ Blog ã§è©³ã—ãè§£èª¬ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ä»¥ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«å…·ä½“çš„ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/opensearch-project/OpenSearch/blob/2.3/server/src/main/java/org/opensearch/cluster/routing/allocation/decider/NodeLoadAwareAllocationDecider.java#L23-L51

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹äºŒç‚¹ã§ã™ã€‚

- NodeLoadAwareAllocationDecider ã¯ã€ã‚·ãƒ£ãƒ¼ãƒ‰ã®éç©è¼‰ãŒç„¡ã„ã‚ˆã†ã«ã‚·ãƒ£ãƒ¼ãƒ‰ã®å‰²ã‚Šå½“ã¦ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚ã‚‹
- ã‚·ãƒ£ãƒ¼ãƒ‰ã®å‰²ã‚Šå½“ã¦ä¸Šé™ã¯ã€ä»¥ä¸‹ã‚ˆã‚Šæ±‚ã‚ã‚‰ã‚Œã‚‹
	- cluster.routing.allocation.overload_awareness.provisioned_capacity : ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®è¨­å®šä¸Šã®ãƒãƒ¼ãƒ‰æ•°
	- cluster.routing.allocation.load_awareness.skew_factor: éç©è¼‰ã®è¨±å®¹ä¿‚æ•° (%)
	- cluster.routing.allocation.load_awareness.flat_skew: éç©è¼‰ã®è¨±å®¹æ•° (å®Ÿæ•°)

å®Ÿéš›ã®åˆ¶é™æ•°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®å¼ã‹ã‚‰æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ceil ã¯ã€å°æ•°ç‚¹ä»¥ä¸‹ã‚’**åˆ‡ã‚Šä¸Šã’ã‚‹**é–¢æ•°ã§ã™ã€‚

```
ceil((ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä¸Šã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°åˆè¨ˆ / provisioned_capacity) * (1 + skew_factor / 100.0)) + flat_skew
```

å®Ÿéš›ã®å‡¦ç†ã¯ä»¥ä¸‹ã‹ã‚‰ç¢ºèªå¯èƒ½ã§ã™ã€‚

https://github.com/opensearch-project/OpenSearch/blob/2.3/server/src/main/java/org/opensearch/cluster/routing/allocation/decider/NodeLoadAwareAllocationDecider.java#L164-L191


ã•ã¦ã€Amazon OpenSearch Service ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ load_awareness ã®è¨­å®šã‚’ç¢ºèªã™ã‚‹ã¨ã€`skew_factor` ã¯ 50.0 (%)ã€`flat_skew` ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã® 2 ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`allow_unassigned_primaries` ãŒ true ã«ãªã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ãƒ—ãƒ©ã‚¤ãƒãƒªã‚·ãƒ£ãƒ¼ãƒ‰ã§ã‚ã‚Œã°ã€Load Aware Shard Allocation ã®åˆ¤å®šå‡¦ç†ã‚’è¡Œã‚ãšã«å‰²ã‚Šå½“ã¦ã‚’è¨±å¯ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ãŒ RED ã«ãªã‚Šã€æ¤œç´¢çµæœãŒæ¬ æã™ã‚‹ã“ã¨ã‚’é˜²ãã“ã¨ãŒã§ãã‚‹ã®ã§ã€true ã«ã—ã¦ãŠãã®ãŒã‚ˆã„ã§ã™ã­ã€‚

```
GET _cluster/settings?include_defaults&filter_path=*.cluster.routing.allocation.awareness,*.cluster.routing.allocation.load_awareness
{
  "persistent" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : {
            "force" : {
              "zone" : {
                "values" : "ap-northeast-1a,ap-northeast-1c,ap-northeast-1d"
              }
            }
          },
          "load_awareness" : {
            "provisioned_capacity" : "6",
            "skew_factor" : "50.0"
          }
        }
      }
    }
  },
  "transient" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : {
            "force" : {
              "zone" : {
                "values" : "ap-northeast-1a,ap-northeast-1c,ap-northeast-1d"
              }
            }
          },
          "load_awareness" : {
            "provisioned_capacity" : "6",
            "skew_factor" : "50.0"
          }
        }
      }
    }
  },
  "defaults" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : {
            "balance" : "false"
          },
          "load_awareness" : {
            "allow_unassigned_primaries" : "true",
            "flat_skew" : "2"
          }
        }
      }
    }
  }
}
```

ä¾‹ãˆã°ã€6 ãƒãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã« 120 ã‚·ãƒ£ãƒ¼ãƒ‰ (Primary 40 + Replica 80) ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒãƒ¼ãƒ‰ã”ã¨ã®ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦ä¸Šé™æ•°ã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚Šã¾ã™ã€‚

```
ceil((ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä¸Šã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°åˆè¨ˆ / provisioned_capacity) * (1 + skew_factor / 100.0)) + flat_skew
= ceil((120 shards / 6 nodes) * (1 + 50.0 / 100.0)) + 2
= 32
```

ã“ã®çŠ¶æ…‹ã§ 1 ãƒãƒ¼ãƒ‰æ¸›å°‘ã—ã€5 ãƒãƒ¼ãƒ‰ã§ 120 ã‚·ãƒ£ãƒ¼ãƒ‰ã‚’å—ã‘æŒã¤ã“ã¨ã«ãªã£ãŸå ´åˆã€æœ¬ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¯ 3 AZ æ§‹æˆã§ã‚ã‚‹ãŸã‚ã€Load Aware Shard Allocation ãŒç„¡ã„çŠ¶æ³ä¸‹ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒãƒ¼ãƒ‰æ§‹æˆã€ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦æ•°ã¨ãªã‚Šã¾ã™

- AZ-1: 2 ãƒãƒ¼ãƒ‰ã€å„ãƒãƒ¼ãƒ‰ã®ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦æ•°ã¯ 20
- AZ-2: 2 ãƒãƒ¼ãƒ‰ã€å„ãƒãƒ¼ãƒ‰ã®ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦æ•°ã¯ 20
- AZ-3: 1 ãƒãƒ¼ãƒ‰ã€å„ãƒãƒ¼ãƒ‰ã®ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦æ•°ã¯ 40

ã“ã“ã« Load Aware Shard Allocation ã‚’ `skew_factor = 50.0`ã€`flat_skew = 2` ã§é©ç”¨ã—ãŸå ´åˆã€ãƒãƒ¼ãƒ‰ã”ã¨ã®ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦æ•°ä¸Šé™ã¯ 32 ã¨ãªã‚Šã¾ã™ã€‚å¾“ã£ã¦ã€AZ-3 ã«ãŠã„ã¦ã¯ã€1 ãƒãƒ¼ãƒ‰ã«ä¸Šé™ã® 32 ã‚·ãƒ£ãƒ¼ãƒ‰ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã€æ®‹ã‚Š 8 ã‚·ãƒ£ãƒ¼ãƒ‰ã¯æœªå‰²ã‚Šå½“ã¦ã¨ãªã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚


## Load Aware Shard Allocation ã®å‹•ä½œæ¤œè¨¼
å…ˆã»ã© Forced Zone Awaraness ã®æ¤œè¨¼ã‚’è¡Œã£ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ã€ä»¥ä¸‹ã®è¨­å®šã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```
PUT /_cluster/settings
{
  "persistent" : {
    "cluster.routing.allocation.load_awareness.provisioned_capacity": "6",
    "cluster.routing.allocation.load_awareness.skew_factor": "50.0"
  },
  "transient" : {
    "cluster.routing.allocation.load_awareness.provisioned_capacity": "6",
    "cluster.routing.allocation.load_awareness.skew_factor": "50.0"
  }
} 
```

ãƒãƒ¼ãƒ‰åœæ­¢å‰ã®å…¨ä½“ã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```
8   164kb 3.6gb 96.2gb 99.9gb 3 10.101.102.99  10.101.102.99  i-03bb5f9150c79f81c
7    73kb 3.7gb 96.2gb 99.9gb 3 10.101.103.40  10.101.103.40  i-08063724f7ad84b48
8 173.2kb 3.6gb 96.2gb 99.9gb 3 10.101.101.119 10.101.101.119 i-03e0f54e75ae6b746
8 200.8kb 3.6gb 96.2gb 99.9gb 3 10.101.102.88  10.101.102.88  i-02ebcae499eb258f0
7    73kb 3.7gb 96.2gb 99.9gb 3 10.101.103.176 10.101.103.176 i-04a9961360c6f509e
8   164kb 3.6gb 96.2gb 99.9gb 3 10.101.101.207 10.101.101.207 i-07f5d670bfd16ffc1
```

1 ãƒãƒ¼ãƒ‰åœæ­¢å¾Œã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚æœªå‰²å½“ã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã¯ç„¡ã„ã‚ˆã†ã§ã™ã­ã€‚

```
GET _cat/allocation
 8 112.7kb 3.6gb 96.2gb 99.9gb 3 10.101.101.119 10.101.101.119 i-03e0f54e75ae6b746
 8   164kb 3.6gb 96.2gb 99.9gb 3 10.101.102.99  10.101.102.99  i-03bb5f9150c79f81c
13  74.3kb 3.6gb 96.2gb 99.9gb 3 10.101.103.176 10.101.103.176 i-04a9961360c6f509e
 8 126.6kb 3.6gb 96.2gb 99.9gb 3 10.101.102.88  10.101.102.88  i-02ebcae499eb258f0
 8   164kb 3.6gb 96.2gb 99.9gb 3 10.101.101.207 10.101.101.207 i-07f5d670bfd16ffc1
```

ã“ã‚Œã¯ä½•æ•…ã‹ã¨ã„ã†ã¨ã€ãƒãƒ¼ãƒ‰ã”ã¨ã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ä¸Šé™ãŒ 14 ã ã‹ã‚‰ã§ã™ã€‚ã¡ãªã¿ã«ã€åœæ­¢å‰ã¨åœæ­¢å¾Œã§ã‚·ãƒ£ãƒ¼ãƒ‰ç·æ•°ãŒç•°ãªã£ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ä¸€éƒ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãƒãƒ¼ãƒ‰æ•°ã«å¿œã˜ã¦ãƒ¬ãƒ—ãƒªã‚«æ•°ã‚’å¯å¤‰ã«ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

```
ceil((ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä¸Šã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°åˆè¨ˆ / provisioned_capacity) * (1 + skew_factor / 100.0)) + flat_skew
= ceil((46 shards / 6 nodes) * (1. 50.0 / 100.0)) + 2
= 14
```

ã“ã“ã§ã‚‚ã†ä¸€ã¤ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
PUT sample-index-2                                            
{
    "settings" : {
        "number_of_shards" : 12,
        "number_of_replicas" : 2
    }
}
```

ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```
GET _cat/allocation?v
shards disk.indices disk.used disk.avail disk.total disk.percent host           ip             node
    14      165.3kb     3.6gb     96.2gb     99.9gb            3 10.101.101.207 10.101.101.207 i-07f5d670bfd16ffc1
    13       74.3kb     3.7gb     96.2gb     99.9gb            3 10.101.103.176 10.101.103.176 i-04a9961360c6f509e
    14      165.3kb     3.6gb     96.2gb     99.9gb            3 10.101.102.99  10.101.102.99  i-03bb5f9150c79f81c
    14      165.2kb     3.6gb     96.2gb     99.9gb            3 10.101.102.88  10.101.102.88  i-02ebcae499eb258f0
    14      151.3kb     3.6gb     96.2gb     99.9gb            3 10.101.101.119 10.101.101.119 i-03e0f54e75ae6b746
    13       74.1kb     3.7gb     96.2gb     99.9gb            3 10.101.103.40  10.101.103.40  i-08063724f7ad84b48
```

ã“ã“ã§ ap-northeast-1d ä¸Šã® 1 ãƒãƒ¼ãƒ‰ã‚’åœæ­¢ã™ã‚‹ã¨ã€ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```
GET
shards disk.indices disk.used disk.avail disk.total disk.percent host           ip             node
    14      165.3kb     3.6gb     96.2gb     99.9gb            3 10.101.102.99  10.101.102.99  i-03bb5f9150c79f81c
    14      165.1kb     3.6gb     96.2gb     99.9gb            3 10.101.102.88  10.101.102.88  i-02ebcae499eb258f0
    23       76.3kb     3.7gb     96.2gb     99.9gb            3 10.101.103.176 10.101.103.176 i-04a9961360c6f509e
    14      151.2kb     3.6gb     96.2gb     99.9gb            3 10.101.101.119 10.101.101.119 i-03e0f54e75ae6b746
    14      165.3kb     3.6gb     96.2gb     99.9gb            3 10.101.101.207 10.101.101.207 i-07f5d670bfd16ffc1
     2                                                                                         UNASSIGNED
```

IP ãŒ 10.101.103.176 ã®ãƒãƒ¼ãƒ‰ã« 23 ã‚·ãƒ£ãƒ¼ãƒ‰ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã®ã¯ã€å¯¾è±¡ã®ãƒãƒ¼ãƒ‰ãŒ ap-northeast-1d ã«æ®‹ã£ã¦ã„ã‚‹å”¯ä¸€ã®ãƒãƒ¼ãƒ‰ã§ã‚ã‚‹ãŸã‚ã§ã™ã€‚åœæ­¢ã—ãŸ ap-northeast-1d ä¸Šã®ã‚·ãƒ£ãƒ¼ãƒ‰ãŒç”Ÿãæ®‹ã£ã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã«ã€Forced Zone Awaraness ã«ã‚ˆã£ã¦ãƒ«ãƒ¼ãƒˆã•ã‚ŒãŸçµæœã§ã™ã­ã€‚ã—ã‹ã—ãªãŒã‚‰ Load Aware Shard Allocation ã«ã‚ˆã£ã¦ 23 ã‚·ãƒ£ãƒ¼ãƒ‰ãŒå‰²ã‚Šå½“ã¦ä¸Šé™ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã€2 ã‚·ãƒ£ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯å‰²ã‚Šå½“ã¦ãã‚Œãšã« UNASSIGNED ã¨ãªã£ã¦ã„ã¾ã™ã€‚

```
ceil((ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä¸Šã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°åˆè¨ˆ / provisioned_capacity) * (1 + skew_factor / 100.0)) + flat_skew
= ceil((81 shards / 6 nodes) * (1. 50.0 / 100.0)) + 2
= 23
```

_cluster/allocation/explain API ã§å‰²ã‚Šå½“ã¦ã«å¤±æ•—ã—ãŸç†ç”±ã‚’ç¢ºèªã™ã‚‹ã¨ã€Load Aware Shard Allocation ã«ã‚ˆã‚‹ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ãŒ explanation ã‹ã‚‰åˆ†ã‹ã‚Šã¾ã™ã€‚

```
GET _cluster/allocation/explain
{
  "index" : "sample-index",
  "shard" : 10,
  "primary" : false,
  "current_state" : "unassigned",
  "unassigned_info" : {
    "reason" : "NODE_LEFT",
    "at" : "2023-01-13T13:08:20.527Z",
    "details" : "node_left [pkPacsbcTLGMYnxpr5D3dw]",
    "last_allocation_status" : "no_attempt"
  },
  "can_allocate" : "no",
  "allocate_explanation" : "cannot allocate because allocation is not permitted to any of the nodes",
  "node_allocation_decisions" : [
    {
      "node_id" : "25k4V2eYT7uPjFBqJNDtTQ",
      "node_name" : "i-02ebcae499eb258f0",
      "transport_address" : "10.101.102.88:9300",
      "node_attributes" : {
        "zone" : "ap-northeast-1c",
        "shard_indexing_pressure_enabled" : "true"
      },
      "node_decision" : "no",
      "deciders" : [
        {
          "decider" : "awareness",
          "decision" : "NO",
          "explanation" : "there are too many copies of the shard allocated to nodes with attribute [zone], there are [3] total configured shard copies for this shard id and [3] total attribute values, expected the allocated shard count per attribute [2] to be less than or equalto the upper bound of the required number of shards per attribute [1]"
        }
      ]
    },
    {
      "node_id" : "A1vnCvo3QKCgAZZd6l2Vig",
      "node_name" : "i-03bb5f9150c79f81c",
      "transport_address" : "10.101.102.99:9300",
      "node_attributes" : {
        "zone" : "ap-northeast-1c",
        "shard_indexing_pressure_enabled" : "true"
      },
      "node_decision" : "no",
      "store" : {
        "matching_size_in_bytes" : 208
      },
      "deciders" : [
        {
          "decider" : "same_shard",
          "decision" : "NO",
          "explanation" : "a copy of this shard is already allocated to this node [[sample-index][10], node[A1vnCvo3QKCgAZZd6l2Vig], [P], s[STARTED], a[id=dIaJEKZUSdOi7lC-G3Vpcw]]"
        },
        {
          "decider" : "awareness",
          "decision" : "NO",
          "explanation" : "there are too many copies of the shard allocated to nodes with attribute [zone], there are [3] total configured shard copies for this shard id and [3] total attribute values, expected the allocated shard count per attribute [2] to be less than or equalto the upper bound of the required number of shards per attribute [1]"
        }
      ]
    },
    {
      "node_id" : "cAeGTS3lR4KnosPkBlZ9ow",
      "node_name" : "i-07f5d670bfd16ffc1",
      "transport_address" : "10.101.101.207:9300",
      "node_attributes" : {
        "zone" : "ap-northeast-1a",
        "shard_indexing_pressure_enabled" : "true"
      },
      "node_decision" : "no",
      "store" : {
        "matching_size_in_bytes" : 0
      },
      "deciders" : [
        {
          "decider" : "same_shard",
          "decision" : "NO",
          "explanation" : "a copy of this shard is already allocated to this node [[sample-index][10], node[cAeGTS3lR4KnosPkBlZ9ow], [R], s[STARTED], a[id=-4JmSCGRQ7q7zCOtaeBvBw]]"
        },
        {
          "decider" : "awareness",
          "decision" : "NO",
          "explanation" : "there are too many copies of the shard allocated to nodes with attribute [zone], there are [3] total configured shard copies for this shard id and [3] total attribute values, expected the allocated shard count per attribute [2] to be less than or equalto the upper bound of the required number of shards per attribute [1]"
        }
      ]
    },
    {
      "node_id" : "dNDdh-TvQPSbfgl7zM0gpA",
      "node_name" : "i-03e0f54e75ae6b746",
      "transport_address" : "10.101.101.119:9300",
      "node_attributes" : {
        "zone" : "ap-northeast-1a",
        "shard_indexing_pressure_enabled" : "true"
      },
      "node_decision" : "no",
      "deciders" : [
        {
          "decider" : "awareness",
          "decision" : "NO",
          "explanation" : "there are too many copies of the shard allocated to nodes with attribute [zone], there are [3] total configured shard copies for this shard id and [3] total attribute values, expected the allocated shard count per attribute [2] to be less than or equalto the upper bound of the required number of shards per attribute [1]"
        }
      ]
    },
    {
      "node_id" : "zEnsTxmeQmOZ3nJT6UUObQ",
      "node_name" : "i-04a9961360c6f509e",
      "transport_address" : "10.101.103.176:9300",
      "node_attributes" : {
        "zone" : "ap-northeast-1d",
        "shard_indexing_pressure_enabled" : "true"
      },
      "node_decision" : "no",
      "deciders" : [
        {
          "decider" : "load_awareness",
          "decision" : "NO",
          "explanation" : "too many shards [23] allocated to this node, limit per node [23] considering overload factor [50.00] and flat skew [2] based on capacity [6]"
        }
      ]
    }
  ]
}
```

# ã¾ã¨ã‚

å®Ÿéš›ã®æŒ™å‹•ã¯å…¬å¼ Blog ã§ä¾‹ç¤ºã—ãŸã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€Forced Awaraness ãŠã‚ˆã³ Load Aware Shard Allocation ã«ã‚ˆã£ã¦ã€ã‚¾ãƒ¼ãƒ³éšœå®³æ™‚ã€ãƒãƒ¼ãƒ‰éšœå®³æ™‚ã®æ®‹å­˜ãƒãƒ¼ãƒ‰ã¸ã®å½±éŸ¿ã¯å®Ÿéš›ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

ç‰¹ã«ãƒãƒ¼ãƒ‰æ•°ãŒå°‘ãªã„ç’°å¢ƒä¸‹ã§ãƒãƒ«ãƒ AZ æ§‹æˆã® Amazon OpenSearch Service ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€ã‚¾ãƒ¼ãƒ³æ•°ã¨ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã‚’è€ƒæ…®ã—ã¤ã¤ã€ãƒãƒ¼ãƒ‰éšœå®³æ™‚ã®ç‰¹å®šã‚¾ãƒ¼ãƒ³ã«ãŠã‘ã‚‹ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦ã®çŠ¶æ³ã‚’ Cluster ã®ãƒ˜ãƒ«ã‚¹çŠ¶æ…‹ (Green, Yellow, Red) ã‚’å…ƒã«ç›£è¦–ã—ã¦ã„ãã“ã¨ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

# è£œè¶³

## Blue/Green Deployment ä¸­ã® Forced Awarenss ã®è¨­å®šã«ã¤ã„ã¦

Blue/Green Deployment ä¸­ã¯ Allocation Awareness ã«é–¢ã™ã‚‹è¨­å®šã¯ä¸€æ™‚çš„ã«å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚æ§‹æˆå¤‰æ›´ä¸­ã¯ã‚·ãƒ£ãƒ¼ãƒ‰å‰²ã‚Šå½“ã¦ä¸Šé™ã®ç®¡ç†ãŒè¤‡é›‘ã«ãªã‚‹ã‹ã‚‰ã ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

```
$ aws opensearch describe-domain-change-progress --domain-name sample
{
    "ChangeProgressStatus": {
        "ChangeId": "130930ed-7e9f-40b0-80c8-3ec97723d3a8",
        "StartTime": "2022-12-28T17:10:53.472000+09:00",
        "Status": "PROCESSING",
        "PendingProperties": [
            "ClusterConfig.InstanceCount"
        ],
        "CompletedProperties": [],
        "TotalNumberOfStages": 5,
        "ChangeProgressStages": [
            {
                "Name": "Validation",
                "Status": "COMPLETED",
                "Description": "Validation Succeeded.",
                "LastUpdated": "2022-12-28T17:11:12.404000+09:00"
            },
            {
                "Name": "Creating a new environment",
                "Status": "COMPLETED",
                "Description": "Preparing resources.",
                "LastUpdated": "2022-12-28T17:17:32.918000+09:00"
            },
            {
                "Name": "Provisioning new nodes",
                "Status": "IN_PROGRESS",
                "Description": "Provisioning new nodes - 0 of 4 completed.",
                "LastUpdated": "2022-12-28T17:21:07.080000+09:00"
            },
            {
                "Name": "Copying shards to new nodes",
                "Status": "PENDING",
                "Description": "Copying shards to new nodes."
            },
            {
                "Name": "Deleting older resources",
                "Status": "PENDING",
                "Description": "Deleting resources associated with the old environment."
            }
        ]
    }
}
```

```
GET _cluster/settings?include_defaults&filter_path=*.cluster.routing.allocation.awareness

{
  "transient" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : { }
        }
      }
    }
  },
  "defaults" : {
    "cluster" : {
      "routing" : {
        "allocation" : {
          "awareness" : {
            "balance" : "false"
          }
        }
      }
    }
  }
}
```