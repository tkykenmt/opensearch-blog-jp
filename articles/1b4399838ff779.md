---
title: "OpenSearch 近似フレームワーク"
emoji: "👋"
topics: []
published: false
---

OpenSearch ユーザーであれば、最新のログ、メトリクス、またはイベントを取得するために OpenSearch クエリを頻繁に実行していることでしょう。例えば、過去 24 時間の最新 100 件のエラーログを取得したり、異常検知のために過去 7 日間のシステムメトリクスを特定したりします。これらのクエリには、時間や数値フィールドでの範囲フィルタ(例: `@timestamp > now-1d`)、ソート(通常は降順)、またはダッシュボードの可視化やアラートを支援する `match_all` クエリが含まれることがよくあります。これらはインタラクティブに使用されたり、ストリーミングダッシュボードで使用されたりするため、レイテンシと効率性がこの体験にとって重要です。

これらのクエリは通常、非スコアリングであり、時系列やイベントベースのデータを可視化する最初のステップとしてよく使用されます。例えば、最新のイベントを取得するためにタイムスタンプフィールドで降順にソートしたり、特定の時間枠内の最も古いエントリを分析するために昇順にソートしたりします。Lucene は、非スコアリング範囲クエリを実行する際にインデックス全体をスキャンする代わりに doc values を賢く使用する最適化(`IndexOrDocValuesQuery`)を導入しましたが、デフォルトのアルゴリズムは依然としてすべてのセグメントを横断し、必要以上に多くのドキュメントをスコアリングすることがよくあります。これにより、実際には少数の上位結果(例: 最初の 50 または 100 ヒット)のみが必要であるにもかかわらず、大量のドキュメントセットを不必要に処理することになります。

これに対処するため、私たちは*近似フレームワーク*を導入しました。これは、対象となるクエリに対して BKD ツリー横断中に早期終了ロジックを適用します。アイデアは、デフォルトの `PointRangeQuery` をオーバーライドし、要求されたヒット数が収集されると停止するカスタム `IntersectVisitor` を注入することで、クエリレイテンシを大幅に削減することです。このアプローチは結果の正確性を保持しながら不必要な作業を回避し、大量の時間ベースまたはイベントベースのワークロードにとって価値ある最適化となります。

バージョン 3.0.0 以降、OpenSearch には近似フレームワークが GA 機能として含まれています。

## 概要

OpenSearch 近似フレームワークは、早期終了を伴うカスタム BKD ツリー横断を実装するクエリ最適化技術です。重要な洞察は、サイズ制限のあるクエリに対して、近似フレームワークはすべての一致するドキュメントを訪問する必要がないということです。十分な結果を収集するとすぐに停止できます。

フレームワークは、以下の機能を持つ標準 Lucene クエリ(`PointRangeQuery` など)のカスタムバージョンを作成します：

- サイズ制限に達すると BKD ツリー横断の**早期終了**
- **正確な結果の返却**により、返されるドキュメントは常に正しい一致
- ソート要件に基づく**最適化された横断順序**

## サポートされるサンプルクエリ形状とタイプ

近似フレームワークは現在、特に `track_total_hits` が `true` に設定されておらず、集約が関与していない場合の以下のクエリパターンに恩恵をもたらします。フレームワークは、`int`、`long`、`float`、`double`、`half_float`、`unsigned_long`、`scaled_float` を含むすべての数値タイプをサポートしています。

### 範囲クエリ

```json
{
  "query": {
    "range": {
      "@timestamp": {
        "gte": "2023-01-01T00:00:00",
        "lt": "2023-01-03T00:00:00"
      }
    }
  }
}
```

フレームワークは BKD ツリーを横断し、要求された `size` が満たされると停止します。

### match_all + ソート (ASC/DESC)

```json
{
  "query": { "match_all": {} },
  "sort": [{ "@timestamp": "desc" }]
}
```

クエリは早期終了を伴う境界付き `range` クエリに自動的に書き換えられます。

### 範囲 + ソート (ASC/DESC)

```json
{
  "query": {
    "range": {
      "@timestamp": {
        "gte": "2023-01-01T00:00:00",
        "lte": "2023-01-13T00:00:00"
      }
    }
  },
  "sort": [{ "@timestamp": "asc" }]
}
```

フレームワークは、上位 `size` ドキュメントを迅速に見つけるために左から右(`ASC`)または右から左(`DESC`)の横断を最適化します。

## BKD ウォーク (カスタム BKD ツリー横断)

すべての一致するドキュメントを訪問する Lucene の標準ツリー横断を使用する代わりに、フレームワークはソート対応横断を伴うカスタム `intersectLeft` および `intersectRight` メソッドを実装し、不必要なノードを訪問することなく正しい上位 N ドキュメントの収集を保証します。

- **`ASC` ソート**: `intersectLeft` を使用して最小値から最大値へ横断します。このメソッドはデフォルトであり、プレーンな範囲クエリに使用されます。
- **`DESC` ソート**: `intersectRight` を使用して最大値から最小値へ横断します。

### 例: 近似を伴う横断

以下の例は、近似を伴う BKD ツリー横断を示しています。

### intersectLeft 横断

以下の図は、近似フレームワークが以下のパラメータを持つクエリに対して BKD ツリー横断を実行する方法を示しています：

- `size` = 1100
- `range` = 10:00 – 10:30

![intersectLeft traversal](https://opensearch.org/wp-content/uploads/2025/07/intersectLeft-traversal-1024x426.png)

目標は 1,100 個の一致するドキュメントのみを収集することであるため、この閾値が満たされると横断は短絡します。

### 横断パス

ツリーは以下のように横断されます：

```
Root → Left1 → Left2 → L1 → L2 → Right2 → L3 → Done
```

- `Right1`、`Left3`、`Right3` およびそれらのすべての子(`L5`–`L8`)などのノードは、ツリーの左側から十分なドキュメントがすでに収集されているため、完全にスキップされます。
- これは、フレームワークが不必要なサブツリーの訪問を回避し、正確な上位 N 結果を返しながらクエリレイテンシを削減する方法を示しています。

### intersectRight 横断

以下の図は、近似フレームワークが以下のパラメータを持つクエリに対して降順ソート(`SortOrder.DESC`)横断を実行する方法を示しています：

- `size` = 1100
- `range` = 10:00 – 10:30

クエリが降順でソートされているため、横断は最も右側(最新)の値を最初に優先します。

![intersectRight traversal](https://opensearch.org/wp-content/uploads/2025/07/intersectRight-traversal-1024x426.png)

### 横断パス

ツリーは以下のように横断されます：

```
Root → Right1 → Right3 → L8 → L7 → Left3 → L6 → Done
```

- 横断が十分なドキュメント(≥1,100)を収集するとすぐに、早期終了し、左側の残りのサブツリーをスキップします。
- `Left1`、`Left2`、`Right2`、およびそれぞれの葉の子などのノードは、降順優先範囲外に該当するか、もはや必要ないため、完全にスキップされます。

## パフォーマンス: ベンチマークテストと結果

数値 `sort`、`range`、`match_all` クエリは全体的に大幅なパフォーマンス向上を見せていますが、以下は P90 レイテンシの改善を強調する具体的なシナリオです。

### big5: 範囲クエリ

`range` クエリは**約 28ms** から**約 6ms** に改善されました。以下のグラフに示されています。

![big5 range query without approximation](https://opensearch.org/wp-content/uploads/2025/07/big5-range-query-without-approximation-1024x552.png)

![big5 range query with approximation](https://opensearch.org/wp-content/uploads/2025/07/big5-range-query-with-approximation-1024x576.png)

### big5: desc_sort_timestamp クエリ

`desc_sort_timestamp` クエリは**約 20ms** から**約 10ms** に改善されました。

![big5 desc_sort_timestamp query without approximation](https://opensearch.org/wp-content/uploads/2025/07/big5-desc_sort_timestamp-query-without-approximation-1024x558.png)

### http_logs: desc_sort_timestamp クエリ

`desc_sort_timestamp` クエリは**約 280ms** から**約 15ms** に改善されました。以下のグラフに示されています。

![http_logs desc_sort_timestamp query without approximation](https://opensearch.org/wp-content/uploads/2025/07/http_logs-desc_sort_timestamp-query-without-approximation-1024x547.png)

![http_logs desc_sort_timestamp query with approximation](https://opensearch.org/wp-content/uploads/2025/07/http_logs-desc_sort_timestamp-query-with-approximation-1024x547.png)

### http_logs: asc_sort_timestamp クエリ

`asc_sort_timestamp` クエリは**約 15ms** から**約 8ms** に改善されました。以下のグラフに示されています。

![http_logs asc_sort_timestamp query without approximation](https://opensearch.org/wp-content/uploads/2025/07/http_logs-asc_sort_timestamp-query-without-approximation-1024x371.png)

![http_logs asc_sort_timestamp query with approximation](https://opensearch.org/wp-content/uploads/2025/07/http_logs-asc_sort_timestamp-query-with-approximation-1024x381.png)

### 追加の改善

特に `sort` クエリパフォーマンスのさらなる改善が OpenSearch 3.1 リリースで観察され、[3.1.0 リリース issue](https://github.com/opensearch-project/opensearch-build/issues/5487#issuecomment-2989202040) で詳細に共有されています。

この結果は `desc_sort_timestamp` の単一セグメントテストから得られました。[このコメント](https://github.com/opensearch-project/OpenSearch/pull/18439#issuecomment-2961325856)によると、最適化されたカスタム BKD ウォーク(`intersectRight`)を伴う単一セグメントへの強制マージにより、P90 レイテンシが**2,111ms** から**6.1ms** へと劇的に削減されました。この改善は、BKD 横断中の早期終了を可能にし、最小限のオーバーヘッドで最も関連性の高いドキュメントを効率的に収集する近似フレームワークによって可能になりました。

開発段階からのベンチマーク結果を捉えた[このコメント](https://github.com/opensearch-project/OpenSearch/pull/18439#issuecomment-2942212895)に示されているように、いくつかのクエリタイプで大幅な改善が見られました：`http_logs`: `desc_sort_size` は**80%** 以上改善、`http_logs`: `desc_sort_timestamp` は**80%** 以上改善、`asc_sort_timestamp` は**80.55%** 以上のパフォーマンス改善を達成しました。

## 今後の改善

高レベルの [META issue](https://github.com/opensearch-project/OpenSearch/issues/18619) には、近似フレームワークに関連する次の拡張セットが含まれています。

以下は、すべての数値タイプをサポートするための近似フレームワークの拡張を含む 3.2.0 リリースで計画されている今後の改善の一部です([関連 PR](https://github.com/opensearch-project/OpenSearch/pull/18530) を参照)。以下の図に示すように、特に歪んだ `http_logs` データセットでテストした場合、`range` および `sort` クエリでも追加のパフォーマンス向上が観察されています。

![http_logs performance comparison](https://opensearch.org/wp-content/uploads/2025/07/http_logs-performance-comparison-1024x450.png)

### http_logs: range_with_asc_sort (2.19.1–3.2.0)

`range_with_asc_sort` クエリは**約 300ms** から**約 30ms** に改善されました。以下のグラフに示されています。

![http_logs range_with_asc_sort query with approximation](https://opensearch.org/wp-content/uploads/2025/07/http_logs-range_with_asc_sort-query-with-approximation-1024x446.png)

### http_logs: range_size (2.19.1–3.2.0)

`range_size` クエリは**約 48ms** から**約 8ms** に改善されました。以下のグラフに示されています。

![http_logs range_size query with approximation](https://opensearch.org/wp-content/uploads/2025/07/http_logs-range_size-query-with-approximation-1024x443.png)

### http_logs: range_with_desc_sort (2.19.1–3.2.0)

`range_with_desc_sort` クエリは**約 312ms** から**約 31ms** に改善されました。以下のグラフに示されています。

![http_logs range_with_desc_sort query with approximation](https://opensearch.org/wp-content/uploads/2025/07/http_logs-range_with_desc_sort-query-with-approximation-1024x448.png)

### nyc_taxis: desc_sort_passenger_count (3.1.0–3.2.0)

`desc_sort_passenger_count` クエリは**約 17ms** から**約 12ms** に改善されました。以下のグラフに示されています。

![nyc_taxis desc_sort_passenger_count query with approximation](https://opensearch.org/wp-content/uploads/2025/07/nyc_taxis-desc_sort_passenger_count-query-with-approximation-1024x443.png)

### 探索中の追加のクエリ形状とタイプ

私たちは、近似フレームワークを追加のクエリタイプに拡張するいくつかの有望な拡張を探索しています。以下は、将来のリリースで対象にできるクエリのタイプです。

### Term クエリ

数値フィールドでの上位レベル `term` クエリにフレームワークを拡張する概念実証では、`http_logs` データセットでレイテンシが約**25%** 減少することが示されました。詳細については、[関連ベンチマーク結果](https://github.com/opensearch-project/OpenSearch/pull/18679#issuecomment-3071292692)と[関連 issue](https://github.com/opensearch-project/OpenSearch/issues/18620)をご覧ください。

### Boolean クエリ

[この関連 issue](https://github.com/opensearch-project/OpenSearch/issues/18692) と [RFC](https://github.com/opensearch-project/OpenSearch/issues/18784) は、概念実証として単一および複数句の `boolean` クエリの両方を最適化できる `ApproximateBooleanQuery` の実装に関する情報を提供しています。

### 数値 search_after クエリ

[この issue](https://github.com/opensearch-project/OpenSearch/issues/18546) で概説された概念実証の取り組み中に、大規模データセットの効率的な深いページネーションのために設計された `search_after` パラメータを使用する数値クエリで大幅な改善が観察されました。`asc_sort_with_after_timestamp` のテストでは、P90 レイテンシが**194.828ms** から**8.459ms** に低下し、`desc_sort_with_after_timestamp` では**188.037ms** から**7.09ms** に低下しました。
